<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Video Wall (4 cams)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 12px; }
    .status { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; margin: 8px 0; }
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .tile {
      border: 1px solid #ddd;
      border-radius: 10px;
      overflow: hidden;
      background: #fff;
    }
    .tileHeader {
      padding: 6px 10px;
      font-size: 12px;
      border-bottom: 1px solid #eee;
      display:flex;
      justify-content: space-between;
      align-items: center;
    }
    .tileHeaderLeft {
      display:flex;
      align-items:center;
      gap: 8px;
      min-width: 0;
    }
    .badge {
      display:inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      background: #f2f2f2;
      font-size: 12px;
      white-space: nowrap;
    }
    .badgeFocus {                /* focus 배지 스타일 */
      background: #ffe8a3;
    }
    iframe {
      width: 100%;
      height: 360px;
      border: 0;
    }
    .controls { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    input { padding: 6px 8px; }
    button { padding: 6px 10px; }
    .muted { color:#666; font-size:12px; } 
  </style>
</head>
<body>
  <h2 style="margin:0 0 8px 0;">Video Panel</h2>

  <div class="status" id="status">status: loading...</div>
  <!-- focus 상태 표시줄 -->
  <div class="status" id="focus">focus_gid: (none)</div>

  <div class="controls">
    <span class="muted">
      tip: query params 지원 → <code>?cams=cam0,cam1,cam2,cam3</code>
    </span>
    <label class="muted">cams</label>
    <input id="camsInput" value="cam0,cam1,cam2,cam3" style="width:260px;"/>
    <button id="applyBtn">Apply</button>
  </div>

  <div class="grid" id="grid"></div>

  <script>
    (function () {
      const DEFAULT_HOST = "10.100.0.21";
      const host =
        (location.hostname && location.hostname !== "127.0.0.1" && location.hostname !== "localhost")
          ? location.hostname
          : DEFAULT_HOST;

      // MediaMTX WebRTC 웹 페이지 포트
      const webrtcBase = `http://${host}:8889`;

      const statusEl = document.getElementById("status");
      const grid = document.getElementById("grid");
      const camsInput = document.getElementById("camsInput");
      const applyBtn = document.getElementById("applyBtn");
     // focus Gid 표시/상태
      const focusEl = document.getElementById("focus");    
      let focusedGid = null;   

      function parseCams() {
        const url = new URL(location.href);
        const q = url.searchParams.get("cams");
        const raw = (q && q.trim().length) ? q : camsInput.value;
        return raw.split(",").map(s => s.trim()).filter(Boolean);
      }

      // focus 상태를 UI에 반영하는 헬퍼
      function renderFocus() {                              
        focusEl.textContent = `focus_gid: ${focusedGid ?? "(none)"}`;
        // 타일 헤더의 focus 배지도 업데이트
        document.querySelectorAll("[data-focus-badge]").forEach(el => {
          if (focusedGid === null || focusedGid === undefined) {
            el.textContent = "FOCUS: -";
            el.classList.remove("badgeFocus");
          } else {
            el.textContent = `FOCUS: ${focusedGid}`;
            el.classList.add("badgeFocus");
          }
        });
      }

      function render() {
        const cams = parseCams();
        camsInput.value = cams.join(",");
        statusEl.textContent = `status: host=${host} | webrtcBase=${webrtcBase} | cams=${cams.join(",")}`;

        grid.innerHTML = cams.slice(0, 4).map((camName, idx) => {
          const src = `${webrtcBase}/${encodeURIComponent(camName)}`;
          return `
            <div class="tile">
              <div class="tileHeader">
                <div class="tileHeaderLeft">
                  <div class="badge">cam: <b>${camName}</b></div>
                  <!-- [NEW] 타일 헤더에 focus 배지 추가 -->
                  <div class="badge" data-focus-badge>FOCUS: -</div>
                </div>
                <a href="${src}" target="_blank" style="font-size:12px;">open</a>
              </div>
              <iframe
                src="${src}"
                allow="autoplay; camera; microphone"
              ></iframe>
            </div>
          `;
        }).join("");
              // 렌더 직후 현재 focus 값 반영
        renderFocus();                                       
      }


      applyBtn.onclick = () => {
        const cams = camsInput.value.split(",").map(s => s.trim()).filter(Boolean);
        const url = new URL(location.href);
        url.searchParams.set("cams", cams.join(","));
        history.replaceState({}, "", url.toString());
        render();
      };

      // =========================
      // /ui WebSocket 구독
      // =========================
      const uiWsUrl = `ws://${host}:8001/ui`;                
      focusEl.textContent = `focus_gid: (connecting) -> ${uiWsUrl}`;  
      const ui = new WebSocket(uiWsUrl);                     

      ui.onopen = () => {                                    
        // 연결되면 현재 focus 표시(아직 없으면 none)
        renderFocus();
      };
      ui.onerror = () => {                                   
        focusEl.textContent = "focus_gid: (ui ws error)";
      };
      ui.onclose = (e) => {                                  
        focusEl.textContent = `focus_gid: (ui ws closed) ${e.code} ${e.reason || ""}`;
      };
      ui.onmessage = (ev) => {                               
        let msg;
        try { msg = JSON.parse(ev.data); } catch { return; }
        if (msg.type === "focus_gid") {
          const gid = msg.data?.gid;
          focusedGid = (gid === null || gid === undefined || gid === "") ? null : Number(gid);
          renderFocus();
        }
      };

      render();
    })();
  </script>
</body>
</html>
